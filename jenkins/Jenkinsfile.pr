pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = "devops-task-manager"
        CONTAINER_NAME = "task-manager-pr-${BUILD_NUMBER}"
        TEST_PORT = "3001"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ðŸ“¥ RÃ©cupÃ©ration du code source...'
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = bat(
                        script: '@git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                }
                echo "âœ… Commit: ${env.GIT_COMMIT_SHORT}"
            }
        }
        
        stage('Setup') {
            steps {
                echo 'âš™ï¸  Configuration de l\'environnement...'
                bat '''
                    echo ðŸ“¦ Node: 
                    node --version
                    echo ðŸ“¦ NPM: 
                    npm --version
                    echo ðŸ³ Docker: 
                    docker --version
                '''
            }
        }
        
        stage('Build') {
            steps {
                echo 'ðŸ”¨ Construction de l\'image Docker...'
                bat """
                    docker build -t %DOCKER_IMAGE%:pr-%BUILD_NUMBER% .
                    echo âœ… Image construite: %DOCKER_IMAGE%:pr-%BUILD_NUMBER%
                """
            }
        }
        
        stage('Run') {
            steps {
                echo 'ðŸš€ DÃ©marrage du conteneur...'
                bat """
                    docker run -d ^
                        --name %CONTAINER_NAME% ^
                        -p %TEST_PORT%:3000 ^
                        %DOCKER_IMAGE%:pr-%BUILD_NUMBER%
                    
                    echo âœ… Conteneur dÃ©marrÃ© sur le port %TEST_PORT%
                    echo â³ Attente de la disponibilitÃ©...
                    ping -n 11 127.0.0.1 > nul
                """
            }
        }
        
        stage('Smoke Test') {
            steps {
                echo 'ðŸ”¥ ExÃ©cution des smoke tests...'
                bat """
                    set TEST_URL=http://localhost:%TEST_PORT%
                    node tests/smoke-test.js
                """
            }
        }
        
        stage('Archive Artifacts') {
            steps {
                echo 'ðŸ“¦ Archivage des artefacts...'
                bat """
                    if not exist artifacts\\pr-%BUILD_NUMBER% mkdir artifacts\\pr-%BUILD_NUMBER%
                    
                    docker logs %CONTAINER_NAME% > artifacts\\pr-%BUILD_NUMBER%\\container-logs.txt 2>&1
                    
                    (
                        echo =================================
                        echo Pipeline PR - Build %BUILD_NUMBER%
                        echo =================================
                        echo Date: %DATE% %TIME%
                        echo Commit: %GIT_COMMIT_SHORT%
                        echo Image: %DOCKER_IMAGE%:pr-%BUILD_NUMBER%
                        echo Port: %TEST_PORT%
                        echo Status: âœ… PASSED
                        echo =================================
                    ) > artifacts\\pr-%BUILD_NUMBER%\\build-info.txt
                    
                    docker images | findstr %DOCKER_IMAGE% > artifacts\\pr-%BUILD_NUMBER%\\docker-images.txt
                """
                
                archiveArtifacts artifacts: 'artifacts/**/*', fingerprint: true
                echo 'âœ… Artefacts archivÃ©s avec succÃ¨s'
            }
        }
        
        stage('Cleanup') {
            steps {
                echo 'ðŸ§¹ Nettoyage...'
                bat """
                    docker stop %CONTAINER_NAME% 2>nul || exit /b 0
                    docker rm %CONTAINER_NAME% 2>nul || exit /b 0
                    docker rmi %DOCKER_IMAGE%:pr-%BUILD_NUMBER% 2>nul || exit /b 0
                    echo âœ… Nettoyage terminÃ©
                """
            }
        }
    }
    
    post {
        success {
            echo 'âœ… ========================================='
            echo 'âœ… Pipeline PR terminÃ© avec succÃ¨s!'
            echo 'âœ… ========================================='
        }
        failure {
            echo 'âŒ ========================================='
            echo 'âŒ Pipeline PR Ã©chouÃ©!'
            echo 'âŒ ========================================='
        }
        always {
            bat """
                docker stop %CONTAINER_NAME% 2>nul || exit /b 0
                docker rm %CONTAINER_NAME% 2>nul || exit /b 0
            """
        }
    }
}