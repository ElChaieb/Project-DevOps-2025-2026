pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = "devops-task-manager"
        CONTAINER_NAME = "task-manager-release-${BUILD_NUMBER}"
        PROD_PORT = "3000"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ðŸ“¥ RÃ©cupÃ©ration de la version taggÃ©e...'
                checkout scm
                script {
                    def tagOutput = bat(
                        script: '@git describe --tags --abbrev=0 2>nul || echo v1.0.0',
                        returnStdout: true
                    ).trim()
                    env.VERSION_TAG = tagOutput
                    env.VERSION_NUMBER = tagOutput.replaceAll('v', '')
                    
                    env.GIT_COMMIT_SHORT = bat(
                        script: '@git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                }
                echo "âœ… Version: ${env.VERSION_TAG} | Commit: ${env.GIT_COMMIT_SHORT}"
            }
        }
        
        stage('Setup') {
            steps {
                echo 'âš™ï¸  PrÃ©paration du build release...'
                bat """
                    echo ðŸ“¦ Version: %VERSION_TAG%
                    echo ðŸ“¦ Build: %BUILD_NUMBER%
                    node --version
                    docker --version
                """
            }
        }
        
        stage('Build') {
            parallel {
                stage('Build Production') {
                    steps {
                        echo 'ðŸ”¨ Construction de l\'image production...'
                        bat """
                            docker build -t %DOCKER_IMAGE%:%VERSION_NUMBER% .
                            docker tag %DOCKER_IMAGE%:%VERSION_NUMBER% %DOCKER_IMAGE%:latest
                            echo âœ… Images crÃ©Ã©es: %DOCKER_IMAGE%:%VERSION_NUMBER% et latest
                        """
                    }
                }
                stage('Build Staging') {
                    steps {
                        echo 'ðŸ”¨ Construction de l\'image staging...'
                        bat """
                            docker build -t %DOCKER_IMAGE%:%VERSION_NUMBER%-staging .
                            echo âœ… Image staging crÃ©Ã©e
                        """
                    }
                }
            }
        }
        
        stage('Run') {
            steps {
                echo 'ðŸš€ DÃ©marrage du conteneur release...'
                bat """
                    docker run -d ^
                        --name %CONTAINER_NAME% ^
                        -p %PROD_PORT%:3000 ^
                        %DOCKER_IMAGE%:%VERSION_NUMBER%
                    
                    echo âœ… Conteneur dÃ©marrÃ© sur le port %PROD_PORT%
                    echo â³ Attente de la disponibilitÃ©...
                    ping -n 16 127.0.0.1 > nul
                """
            }
        }
        
        stage('Smoke Test') {
            steps {
                echo 'ðŸ”¥ ExÃ©cution des tests smoke production...'
                bat """
                    set TEST_URL=http://localhost:%PROD_PORT%
                    node tests/smoke-test.js
                """
            }
        }
        
        stage('Archive Artifacts') {
            steps {
                echo 'ðŸ“¦ Archivage des artefacts release...'
                bat """
                    if not exist artifacts\\releases\\%VERSION_NUMBER% mkdir artifacts\\releases\\%VERSION_NUMBER%
                    
                    docker logs %CONTAINER_NAME% > artifacts\\releases\\%VERSION_NUMBER%\\production-logs.txt 2>&1
                    
                    (
                        echo ================================================
                        echo ðŸš€ RELEASE NOTES - Version %VERSION_TAG%
                        echo ================================================
                        echo.
                        echo Version:        %VERSION_NUMBER%
                        echo Tag Git:        %VERSION_TAG%
                        echo Build Number:   %BUILD_NUMBER%
                        echo Commit:         %GIT_COMMIT_SHORT%
                        echo Date:           %DATE% %TIME%
                        echo.
                        echo Images Docker:
                        echo - %DOCKER_IMAGE%:%VERSION_NUMBER%
                        echo - %DOCKER_IMAGE%:%VERSION_NUMBER%-staging
                        echo - %DOCKER_IMAGE%:latest
                        echo.
                        echo Status: âœ… SUCCESS - Ready for deployment
                        echo ================================================
                    ) > artifacts\\releases\\%VERSION_NUMBER%\\RELEASE-NOTES.txt
                    
                    docker inspect %DOCKER_IMAGE%:%VERSION_NUMBER% > artifacts\\releases\\%VERSION_NUMBER%\\image-manifest.json
                    docker images | findstr %DOCKER_IMAGE% > artifacts\\releases\\%VERSION_NUMBER%\\images-list.txt
                    
                    (
                        echo @echo off
                        echo docker pull %DOCKER_IMAGE%:%VERSION_NUMBER%
                        echo docker stop task-manager-prod 2^>nul
                        echo docker rm task-manager-prod 2^>nul
                        echo docker run -d --name task-manager-prod -p 80:3000 %DOCKER_IMAGE%:%VERSION_NUMBER%
                        echo echo âœ… DÃ©ploiement terminÃ©
                    ) > artifacts\\releases\\%VERSION_NUMBER%\\deploy.bat
                """
                
                archiveArtifacts artifacts: 'artifacts/**/*', fingerprint: true
                echo 'âœ… Artefacts archivÃ©s dans Jenkins'
            }
        }
        
        stage('Cleanup') {
            steps {
                echo 'ðŸ§¹ Nettoyage...'
                bat """
                    docker stop %CONTAINER_NAME% 2>nul || exit /b 0
                    docker rm %CONTAINER_NAME% 2>nul || exit /b 0
                    echo âœ… Nettoyage terminÃ© - Images conservÃ©es
                """
            }
        }
    }
    
    post {
        success {
            echo 'âœ… ================================================='
            echo 'âœ… PIPELINE RELEASE TERMINÃ‰ AVEC SUCCÃˆS!'
            echo "âœ… Version: ${env.VERSION_TAG}"
            echo 'âœ… ================================================='
        }
        failure {
            echo 'âŒ ================================================='
            echo 'âŒ PIPELINE RELEASE Ã‰CHOUÃ‰!'
            echo 'âŒ ================================================='
        }
        always {
            bat """
                docker stop %CONTAINER_NAME% 2>nul || exit /b 0
                docker rm %CONTAINER_NAME% 2>nul || exit /b 0
            """
        }
    }
}
